import streamlit as st
import ollama

# --- –í–ê–ñ–ù–û: –ò–º—è —Ñ–∞–π–ª–∞ –ª–æ–≥–æ—Ç–∏–ø–∞ ---
# –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—á–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞, –∫–æ—Ç–æ—Ä–æ–µ –≤—ã —É–∫–∞–∑–∞–ª–∏: logonpg.png
LOGO_FILENAME = "logonpg.png" 

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Streamlit (—Å –ª–æ–≥–æ—Ç–∏–ø–æ–º –∏ –∏–∫–æ–Ω–∫–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã) ---
st.set_page_config(
    page_title="–ß–∞—Ç-–±–æ—Ç Mastercard",
    layout="wide",
    page_icon=LOGO_FILENAME 
)

st.image(LOGO_FILENAME, width=100) # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ª–æ–≥–æ—Ç–∏–ø
st.title("–ß–∞—Ç-–±–æ—Ç Mastercard –Ω–∞ Llama 3")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ (–µ—Å–ª–∏ –µ–µ –Ω–µ—Ç)
if "messages" not in st.session_state:
    # –§–∏–Ω–∞–ª—å–Ω—ã–π –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç: –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–æ–ª—å AI, –≤–∫–ª—é—á–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —è–∑—ã–∫ –∏ –¥–∏–∑–∞–π–Ω
    st.session_state["messages"] = [
        {"role": "system", "content": "–¢—ã - –≤—ã—Å–æ–∫–æ–∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∏ —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ø–ª–∞—Ç–µ–∂–Ω—ã–º —Å–∏—Å—Ç–µ–º–∞–º Mastercard. –¢–≤–æ—è –æ—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ ‚Äî –¥–∞–≤–∞—Ç—å —Ç–æ—á–Ω—ã–µ, –ø–æ–ª–µ–∑–Ω—ã–µ –∏ –≤–µ–∂–ª–∏–≤—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –ø—Ä–æ–¥—É–∫—Ç–∞—Ö –∏ —É—Å–ª—É–≥–∞—Ö –∫–æ–º–ø–∞–Ω–∏–∏ Mastercard. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π —è–∑—ã–∫ –∫–∞–∂–¥–æ–≥–æ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞. –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä–æ–≥–æ –Ω–∞ —Ç–æ–º —è–∑—ã–∫–µ, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –∑–∞–¥–∞–Ω –≤–æ–ø—Ä–æ—Å. –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –ø–æ —Ç–µ–º–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤ –∏ –ø–ª–∞—Ç–µ–∂–µ–π, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å Mastercard. –í–°–ï–ì–î–ê –±—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –≥–æ—Å—Ç–µ–ø—Ä–∏–∏–º–Ω—ã–º."},
        {"role": "assistant", "content": "üëã –ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –æ—Ç Mastercard. –°–ø—Ä–∞—à–∏–≤–∞–π—Ç–µ –æ –∫–∞—Ä—Ç–∞—Ö, –ø–ª–∞—Ç–µ–∂–∞—Ö –∏ —É—Å–ª—É–≥–∞—Ö ‚Äì —è –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å!"}
    ]

# –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
for message in st.session_state["messages"]:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

# --- –õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ ---
if prompt := st.chat_input("–í–∞—à –≤–æ–ø—Ä–æ—Å:"):
    # 1. –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å—Ç–æ—Ä–∏—é
    st.session_state["messages"].append({"role": "user", "content": prompt})
    
    # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    with st.chat_message("user"):
        st.markdown(prompt)

    # 2. –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è Ollama (–≤–∫–ª—é—á–∞—è —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç)
    history = [
        {"role": m["role"], "content": m["content"]}
        for m in st.session_state["messages"]
    ]

    # 3. –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç Ollama
    with st.chat_message("assistant"):
        with st.spinner('Llama 3 –¥—É–º–∞–µ—Ç...'):
            try:
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é Ollama, —á—Ç–æ–±—ã –º–æ–¥–µ–ª—å –ø–æ–º–Ω–∏–ª–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç
                response = ollama.chat(
                    model='llama3',
                    messages=history
                )
                ai_response = response['message']['content']
                st.markdown(ai_response)
            except Exception as e:
                ai_response = f"–û—à–∏–±–∫–∞: –ù–µ –º–æ–≥—É –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Ollama. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ 'ollama run llama3' –∑–∞–ø—É—â–µ–Ω –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –æ–∫–Ω–µ CMD."
                st.markdown(ai_response)

    # 4. –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç AI –≤ –∏—Å—Ç–æ—Ä–∏—é
    st.session_state["messages"].append({"role": "assistant", "content": ai_response})